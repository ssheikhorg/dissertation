<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Model Evaluation Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="/static/index.css" rel="stylesheet">
    <style>
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .results-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .metric-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .improvement-positive {
            color: #27ae60;
        }

        .improvement-negative {
            color: #e74c3c;
        }

        .sample-response {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .suggestion {
            background: #e8f4fc;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<nav>
    <a href="#" onclick="showPage('home')">Home</a>
    <a href="#" onclick="showPage('evaluate')">Single Model Evaluation</a>
    <a href="#" onclick="showPage('compare')">Model Comparison</a>
    <a href="#" onclick="showPage('visualize')">Visualizations</a>
    <a href="#" onclick="showPage('saved-results')">Saved Results</a>
</nav>
<main>
    <!-- Home Page -->
    <div id="home-page" class="page active">
        <div class="hero">
            <h1>Local Model Evaluation Dashboard</h1>
            <p>Evaluate and compare local LLM models with focus on hallucination detection</p>
        </div>

        <div class="features">
            <div class="feature-card">
                <a href="#" onclick="showPage('evaluate')">
                    <h2>Single Model Evaluation</h2>
                    <p>Test individual model performance with detailed metrics</p>
                </a>
            </div>

            <div class="feature-card">
                <a href="#" onclick="showPage('compare')">
                    <h2>Model Comparison</h2>
                    <p>Compare multiple models side-by-side</p>
                </a>
            </div>

            <div class="feature-card">
                <a href="#" onclick="showPage('visualize')">
                    <h2>Visualizations</h2>
                    <p>Interactive charts and analysis</p>
                </a>
            </div>
        </div>

        <div class="recent-evaluations">
            <h2>Recent Evaluations</h2>
            <div id="recent-evals-container" hx-get="/api/recent-evaluations" hx-trigger="load">
                <p>Loading recent evaluations...</p>
            </div>
        </div>
    </div>

    <!-- Evaluation Page -->
    <div id="evaluate-page" class="page">
        <div class="evaluation-container">
            <h1>Model Evaluation</h1>

            <form>
                <div class="controls">
                    <div class="control-group">
                        <label for="model-select">Model:</label>
                        <select id="model-select" name="model_name">
                            <option value="claude-3.7">Claude 3.7</option>
                            <option value="mistral-7b">Mistral 7B</option>
                            <option value="llama-2-7b">LLaMA 2 (7B)</option>
                            <option value="qwen-7b">Qwen 7B</option>
                            <option value="meditron-7b">Meditron 7B</option>
                            <option value="biomedgpt">BioMedGPT</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="dataset-select-eval">Dataset:</label>
                        <select id="dataset-select-eval" name="dataset">
                            <option value="pubmed_qa">PubMed QA</option>
                            <option value="med_qa">Med QA</option>
                            <option value="truthful_qa">Truthful QA</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="sample-count-eval">Sample Count:</label>
                        <input type="range" id="sample-count-eval" name="sample_count" min="1" max="10" value="3">
                        <span id="sample-count-value-eval">3</span>
                    </div>

                    <div class="control-group">
                        <label for="rag-toggle">Use RAG (Medical Context):</label>
                        <input type="checkbox" id="rag-toggle" name="use_rag" checked>
                    </div>

                    <button
                            hx-post="/api/evaluate"
                            hx-include="[name]"
                            hx-target="#results-eval"
                            hx-indicator=".loading-eval"
                            class="primary-button">
                        Run Evaluation
                    </button>
                </div>
            </form>

            <div class="loading loading-eval">
                <div class="spinner"></div>
                <p>Evaluating model... This may take a few minutes for local models.</p>
            </div>

            <div id="results-eval" class="results-container"></div>
        </div>
    </div>

    <!-- Comparison Page -->
    <div id="compare-page" class="page">
        <div class="comparison-container">
            <h1>Model Comparison</h1>

            <form>
                <div class="controls">
                    <div class="control-group">
                        <label>Models to Compare:</label>
                        <div class="model-selection">
                            <select id="model1-select" name="model1">
                                <option value="claude-3.7">Claude 3.7</option>
                                <option value="mistral-7b">Mistral 7B</option>
                                <option value="llama-2-7b">LLaMA 2 (7B)</option>
                                <option value="qwen-7b">Qwen 7B</option>
                                <option value="meditron-7b">Meditron 7B</option>
                                <option value="biomedgpt">BioMedGPT</option>
                            </select>
                            <span>vs</span>
                            <select id="model2-select" name="model2">
                                <option value="mistral-7b">Mistral 7B</option>
                                <option value="claude-3.7">Claude 3.7</option>
                                <option value="llama-2-7b">LLaMA 2 (7B)</option>
                                <option value="qwen-7b">Qwen 7B</option>
                                <option value="meditron-7b">Meditron 7B</option>
                                <option value="biomedgpt">BioMedGPT</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="dataset-select-comp">Dataset:</label>
                        <select id="dataset-select-comp" name="dataset">
                            <option value="pubmed_qa">PubMed QA</option>
                            <option value="med_qa">Med QA</option>
                            <option value="truthful_qa">Truthful QA</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="sample-count-comp">Sample Count:</label>
                        <input type="range" id="sample-count-comp" name="sample_count" min="1" max="10" value="3">
                        <span id="sample-count-value-comp">3</span>
                    </div>

                    <div class="control-group">
                        <label for="rag-comp">Use RAG (Medical Context):</label>
                        <input type="checkbox" id="rag-comp" name="use_rag" checked>
                    </div>

                    <button
                            hx-post="/api/compare"
                            hx-include="[name]"
                            hx-target="#results-comp"
                            hx-indicator=".loading-comp"
                            class="primary-button">
                        Compare Models
                    </button>
                </div>
            </form>

            <div class="loading loading-comp">
                <div class="spinner"></div>
                <p>Comparing models... This may take a few minutes for local models.</p>
            </div>

            <div id="results-comp" class="results-container"></div>
        </div>
    </div>

    <!-- Saved results section -->
    <div id="saved-results-page" class="page">
        <div class="saved-results-container">
            <h1>Saved Evaluation Results</h1>

            <div class="results-actions">
                <button onclick="refreshResults()" class="primary-button">Refresh Results</button>
                <button onclick="loadAllResults()" class="secondary-button">Load All Results</button>
            </div>

            <div class="filter-section">
                <label for="model-filter">Filter by Model:</label>
                <select id="model-filter" onchange="filterResults()">
                    <option value="all">All Models</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>

            <h3>Saved Evaluation Results</h3>
            <div id="saved-results-list">
                <p>Loading saved results...</p>
            </div>
        </div>
    </div>

    <!-- Visualization Page -->
    <div id="visualize-page" class="page">
        <div class="visualization-container">
            <h1>Model Evaluation Visualizations</h1>

            <form>
                <div class="controls">
                    <div class="control-group">
                        <label for="visualization-type">Visualization Type:</label>
                        <select id="visualization-type" name="visualization_type">
                            <option value="bar">Bar Chart</option>
                            <option value="radar">Radar Chart</option>
                            <option value="scatter">Scatter Plot</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="metric-select">Metric:</label>
                        <select id="metric-select" name="metric">
                            <option value="hallucination_rate">Hallucination Rate</option>
                            <option value="accuracy">Accuracy</option>
                            <option value="confidence">Confidence</option>
                            <option value="response_length">Response Length</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="models-select">Models:</label>
                        <select id="models-select" name="models" multiple style="height: 120px;">
                            <option value="claude-3.7" selected>Claude 3.7</option>
                            <option value="mistral-7b" selected>Mistral 7B</option>
                            <option value="llama-2-7b">LLaMA 2 (7B)</option>
                            <option value="qwen-7b">Qwen 7B</option>
                            <option value="meditron-7b">Meditron 7B</option>
                            <option value="biomedgpt">BioMedGPT</option>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple models</small>
                    </div>

                    <button
                            hx-get="/api/visualize"
                            hx-include="[name]"
                            hx-target="#visualization-container"
                            hx-indicator=".loading-viz"
                            class="primary-button">
                        Generate Visualization
                    </button>
                </div>
            </form>

            <div class="loading loading-viz">
                <div class="spinner"></div>
                <p>Generating visualization...</p>
            </div>

            <div id="visualization-container" class="chart-container"></div>
        </div>
    </div>
</main>

<footer>
    <div class="footer-content">
        <p>This Model Evaluation Dashboard was developed by <strong>Sheikh Shahin Shapon</strong> as part of his MSc
            Dissertation on <em>"Hallucination Detection in Large Language Models for Medical Applications"</em></p>
        <p>Â© 2024 Sheikh Shahin Shapon - All rights reserved</p>
    </div>
</footer>

<script>
    // Update page navigation to handle URL changes
    function showPage(pageId) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        // Show selected page
        document.getElementById(`${pageId}-page`).classList.add('active');

        // Update URL without reloading
        const url = pageId === 'home' ? '/' : `/${pageId}`;
        window.history.pushState({}, '', url);
    }

    // Load available models from API on page load
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/models')
                .then(response => response.json())
                .then(data => {
                    const modelSelect = document.getElementById('model-select');
                    const model1Select = document.getElementById('model1-select');
                    const model2Select = document.getElementById('model2-select');
                    const modelsVisualization = document.getElementById('models-select');

                    // Clear existing options
                    modelSelect.innerHTML = '';
                    model1Select.innerHTML = '';
                    model2Select.innerHTML = '';
                    modelsVisualization.innerHTML = '';

                    // Add available models
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;

                        const option2 = option.cloneNode(true);
                        const option3 = option.cloneNode(true);
                        const option4 = option.cloneNode(true);

                        modelSelect.appendChild(option);
                        model1Select.appendChild(option2);
                        model2Select.appendChild(option3);
                        modelsVisualization.appendChild(option4);
                    });
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                });
    });

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function (event) {
        const path = window.location.pathname;
        let pageId = 'home';

        if (path === '/evaluate') pageId = 'evaluate';
        else if (path === '/compare') pageId = 'compare';
        else if (path === '/visualize') pageId = 'visualize';

        showPage(pageId);
    });

    // Update sample count displays
    document.addEventListener('DOMContentLoaded', function () {
        const evalSlider = document.getElementById('sample-count-eval');
        const evalValue = document.getElementById('sample-count-value-eval');
        const compSlider = document.getElementById('sample-count-comp');
        const compValue = document.getElementById('sample-count-value-comp');

        if (evalSlider && evalValue) {
            evalSlider.addEventListener('input', () => {
                evalValue.textContent = evalSlider.value;
            });
        }

        if (compSlider && compValue) {
            compSlider.addEventListener('input', () => {
                compValue.textContent = compSlider.value;
            });
        }

        // Set initial page based on URL
        const path = window.location.pathname;
        let pageId = 'home';

        if (path === '/evaluate') pageId = 'evaluate';
        else if (path === '/compare') pageId = 'compare';
        else if (path === '/visualize') pageId = 'visualize';

        showPage(pageId);
    });

    // Handle form submissions and show loading indicators
    document.body.addEventListener('htmx:beforeRequest', function (evt) {
        const target = evt.detail.target.id;
        if (target === 'results-eval') {
            document.querySelector('.loading-eval').classList.add('active');
        } else if (target === 'results-comp') {
            document.querySelector('.loading-comp').classList.add('active');
        } else if (target === 'visualization-container') {
            document.querySelector('.loading-viz').classList.add('active');
        }
    });

    document.body.addEventListener('htmx:afterRequest', function (evt) {
        const target = evt.detail.target.id;
        if (target === 'results-eval') {
            document.querySelector('.loading-eval').classList.remove('active');
        } else if (target === 'results-comp') {
            document.querySelector('.loading-comp').classList.remove('active');
        } else if (target === 'visualization-container') {
            document.querySelector('.loading-viz').classList.remove('active');
        }
    });

    // Handle visualization rendering
    document.addEventListener('htmx:afterSwap', function (event) {
        if (event.detail.target.id === 'visualization-container') {
            const response = event.detail.xhr.responseText;
            try {
                const data = JSON.parse(response);

                if (data.error) {
                    document.getElementById('visualization-container').innerHTML = `
                        <div class="error-message">${data.error}</div>
                    `;
                    return;
                }

                // Render the chart based on the data
                renderVisualization(data);
            } catch (e) {
                console.error('Error parsing visualization data:', e);
            }
        }
    });

    // Function to render visualization
    function renderVisualization(data) {
        const container = document.getElementById('visualization-container');
        container.innerHTML = ''; // Clear previous content

        if (data.type === 'bar') {
            renderBarChart(data, container);
        } else if (data.type === 'radar') {
            renderRadarChart(data, container);
        } else if (data.type === 'scatter') {
            renderScatterChart(data, container);
        } else {
            container.innerHTML = `<p>Unsupported visualization type: ${data.type}</p>`;
        }
    }

    // Load saved results
    async function loadSavedResults() {
        const resultsList = document.getElementById('saved-results-list');
        const modelFilter = document.getElementById('model-filter');

        try {
            const response = await fetch('/api/saved-results');
            const data = await response.json();

            if (data.results.length === 0) {
                resultsList.innerHTML = '<p>No saved results yet. Run evaluations to see results here.</p>';
                return;
            }

            // Populate model filter
            const models = [...new Set(data.results.map(r => r.model))];
            modelFilter.innerHTML = '<option value="all">All Models</option>' +
                models.map(model => `<option value="${model}">${model}</option>`).join('');

            // Display results
            displayResults(data.results);
        } catch (error) {
            resultsList.innerHTML = `
                <div class="error-message">
                    Error loading results: ${error.message}
                </div>
            `;
        }
    }

    // Display results with filtering
    function displayResults(results, filterModel = 'all') {
        const resultsList = document.getElementById('saved-results-list');

        const filteredResults = filterModel === 'all'
            ? results
            : results.filter(r => r.model === filterModel);

        if (filteredResults.length === 0) {
            resultsList.innerHTML = '<p>No results found for the selected filter.</p>';
            return;
        }

        resultsList.innerHTML = filteredResults.map(result => `
            <div class="saved-result-card">
                <h4>${result.model}</h4>
                <p><strong>Dataset:</strong> ${result.dataset}</p>
                <p><strong>Samples:</strong> ${result.sample_count}</p>
                <p><strong>Date:</strong> ${new Date(result.date).toLocaleString()}</p>
                <p><strong>Accuracy:</strong> ${(result.metrics.accuracy * 100).toFixed(1)}%</p>
                <p><strong>Hallucination Rate:</strong> ${(result.metrics.hallucination_rate * 100).toFixed(1)}%</p>
                <div class="result-actions">
                    <button onclick="viewSavedResult('${result.model}', '${result.dataset}')">View Details</button>
                    <button onclick="useForVisualization('${result.model}')">Use in Visualization</button>
                    <button onclick="deleteSavedResult('${result.model}', '${result.dataset}')" class="delete-btn">Delete</button>
                </div>
            </div>
        `).join('');
    }

    // Filter results by model
    function filterResults() {
        const modelFilter = document.getElementById('model-filter');
        const selectedModel = modelFilter.value;

        // Reload results with filter
        fetch('/api/saved-results')
            .then(response => response.json())
            .then(data => displayResults(data.results, selectedModel))
            .catch(error => console.error('Error filtering results:', error));
    }

    // View saved result details
    async function viewSavedResult(modelName, dataset) {
        try {
            const response = await fetch(`/api/saved-result/${modelName}?dataset=${dataset}`);
            const result = await response.json();

            // Format and display the result
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>Evaluation Results: ${result.model}</h2>
                    <p><strong>Dataset:</strong> ${result.dataset}</p>
                    <p><strong>Evaluation Date:</strong> ${new Date(result.evaluation_date).toLocaleString()}</p>

                    <div class="metrics-grid">
                        <div class="metric-card">
                            <h3>Accuracy</h3>
                            <div class="metric-value">${(result.metrics.accuracy * 100).toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <h3>Hallucination Rate</h3>
                            <div class="metric-value">${(result.metrics.hallucination_rate * 100).toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <h3>Confidence</h3>
                            <div class="metric-value">${(result.metrics.confidence * 100).toFixed(1)}%</div>
                        </div>
                    </div>

                    ${result.improvement ? `
                    <h3>Improvement vs Baseline</h3>
                    <div class="improvement-metrics">
                        <p>Accuracy Improvement: <span class="${result.improvement.accuracy_improvement > 0 ? 'positive' : 'negative'}">${result.improvement.accuracy_improvement > 0 ? '+' : ''}${result.improvement.accuracy_improvement.toFixed(1)}%</span></p>
                        <p>Hallucination Reduction: <span class="${result.improvement.hallucination_reduction > 0 ? 'positive' : 'negative'}">${result.improvement.hallucination_reduction > 0 ? '+' : ''}${result.improvement.hallucination_reduction.toFixed(1)}%</span></p>
                    </div>
                    ` : ''}

                    <h3>Sample Responses</h3>
                    ${result.sample_responses ? result.sample_responses.map((response, index) => `
                        <div class="sample-response">
                            <h4>Sample ${index + 1}</h4>
                            <p><strong>Prompt:</strong> ${response.prompt}</p>
                            <p><strong>Reference:</strong> ${response.reference}</p>
                            <p><strong>Model Response:</strong> ${response.response}</p>
                            <p><strong>Accuracy:</strong> ${(response.accuracy * 100).toFixed(1)}%</p>
                            <p><strong>Hallucination Score:</strong> ${(response.hallucination_score * 100).toFixed(1)}%</p>
                        </div>
                    `).join('') : '<p>No sample responses available</p>'}
                </div>
            `;
            document.body.appendChild(modal);
        } catch (error) {
            alert(`Error viewing result: ${error.message}`);
        }
    }

    // Use result for visualization
    function useForVisualization(modelName) {
        // Switch to visualization page and pre-select this model
        showPage('visualize');

        // Add model to visualization selection
        const modelsSelect = document.getElementById('models-select');
        const options = Array.from(modelsSelect.options);
        const modelOption = options.find(opt => opt.value === modelName);

        if (modelOption) {
            modelOption.selected = true;
        } else {
            // Add model to selection if not already there
            const newOption = new Option(modelName, modelName, false, true);
            modelsSelect.add(newOption);
        }

        // Trigger visualization generation
        setTimeout(() => {
            document.querySelector('#visualize-page button').click();
        }, 500);
    }

    // Delete saved result
    async function deleteSavedResult(modelName, dataset) {
        if (!confirm(`Are you sure you want to delete all saved results for ${modelName}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/saved-result/${modelName}?dataset=${dataset}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadSavedResults(); // Refresh the list
            } else {
                alert('Error deleting result');
            }
        } catch (error) {
            alert(`Error deleting result: ${error.message}`);
        }
    }

    // Refresh results
    function refreshResults() {
        loadSavedResults();
    }

    // Load all results (no filter)
    function loadAllResults() {
        fetch('/api/saved-results')
            .then(response => response.json())
            .then(data => displayResults(data.results, 'all'))
            .catch(error => console.error('Error loading results:', error));
    }

    // Update DOMContentLoaded to load saved results
    document.addEventListener('DOMContentLoaded', function() {
        // Add this to your existing DOMContentLoaded function
        if (window.location.pathname === '/saved-results') {
            loadSavedResults();
        }
    });

    // Update showPage function
    function showPage(pageId) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        // Show selected page
        document.getElementById(`${pageId}-page`).classList.add('active');

        // Update URL without reloading
        const url = pageId === 'home' ? '/' : `/${pageId}`;
        window.history.pushState({}, '', url);

        // Load saved results if on saved-results page
        if (pageId === 'saved-results') {
            loadSavedResults();
        }
    }
    // Chart rendering functions
    function renderBarChart(data, container) {
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);

        new Chart(canvas, {
            type: 'bar',
            data: data.data,
            options: data.options
        });
    }

    function renderRadarChart(data, container) {
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);

        new Chart(canvas, {
            type: 'radar',
            data: data.data,
            options: data.options
        });
    }

    function renderScatterChart(data, container) {
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);

        new Chart(canvas, {
            type: 'scatter',
            data: data.data,
            options: data.options
        });
    }

    // Handle response rendering for evaluation results
    document.addEventListener('htmx:afterSwap', function (event) {
        if (event.detail.target.id === 'results-eval' || event.detail.target.id === 'results-comp') {
            const response = event.detail.xhr.responseText;
            try {
                const data = JSON.parse(response);

                if (data.error) {
                    event.detail.target.innerHTML = `
                        <div class="error-message">
                            <h3>Error</h3>
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }

                // Format the response for better readability
                formatEvaluationResults(data, event.detail.target.id);
            } catch (e) {
                // Response is already formatted HTML
            }
        }
    });

    // Format evaluation results for better display
    function formatEvaluationResults(data, targetId) {
        const container = document.getElementById(targetId);

        if (targetId === 'results-eval') {
            // Single evaluation result
            container.innerHTML = `
                <h2>Evaluation Results: ${data.model}</h2>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Accuracy</h3>
                        <div class="metric-value">${(data.metrics.accuracy * 100).toFixed(1)}%</div>
                        <div class="improvement-${data.improvement.accuracy_improvement > 0 ? 'positive' : 'negative'}">
                            ${data.improvement.accuracy_improvement > 0 ? '+' : ''}${data.improvement.accuracy_improvement.toFixed(1)}% vs baseline
                        </div>
                    </div>

                    <div class="metric-card">
                        <h3>Hallucination Rate</h3>
                        <div class="metric-value">${(data.metrics.hallucination_rate * 100).toFixed(1)}%</div>
                        <div class="improvement-${data.improvement.hallucination_reduction > 0 ? 'positive' : 'negative'}">
                            ${data.improvement.hallucination_reduction > 0 ? '-' : '+'}${Math.abs(data.improvement.hallucination_reduction).toFixed(1)}% vs baseline
                        </div>
                    </div>

                    <div class="metric-card">
                        <h3>Confidence</h3>
                        <div class="metric-value">${(data.metrics.confidence * 100).toFixed(1)}%</div>
                    </div>

                    <div class="metric-card">
                        <h3>Response Length</h3>
                        <div class="metric-value">${data.metrics.response_length.toFixed(0)} chars</div>
                    </div>
                </div>

                <h3>Improvement Suggestions</h3>
                <div class="suggestions">
                    ${data.suggestions.map(suggestion => `
                    <div class="suggestion">
                    <strong>${suggestion.category}:</strong> ${suggestion.suggestion}
                            <br><em>Expected impact: ${suggestion.expected_impact}</em>
                        </div>
                    `
        ).
            join('')
        }
    </div>

        <h3>Sample Responses</h3>
        <div class="sample-responses">
        ${data.sample_responses.map((response, index) => `
                        <div class="sample-response">
                            <h4>Sample ${index + 1}</h4>
        <p><strong>Prompt:</strong> ${response.prompt}</p>
        <p><strong>Reference:</strong> ${response.reference}</p>
        <p><strong>Model Response:</strong> ${response.response}</p>
        <p><strong>Accuracy:</strong> ${(response.accuracy * 100).toFixed(1)}%</p>
        <p><strong>Hallucination Score:</strong> ${(response.hallucination_score * 100).toFixed(1)}%</p>
    </div>
        `).join('')}
                </div>
            `;
    }

    else
    if (targetId === 'results-comp') {
        // Comparison results
        container.innerHTML = `
                <h2>Model Comparison Results</h2>

                <div class="comparison-metrics">
                    ${Object.entries(data.comparison).map(([metric, comparison]) => `
                <div class="metric-card">
                <h3>${metric.replace('_', ' ').toUpperCase()}</h3>
                            <p><strong>Best:</strong> ${comparison.best_model} (${(comparison.values[comparison.best_model] * 100).toFixed(1)}%)</p>
                            <p><strong>Worst:</strong> ${comparison.worst_model} (${(comparison.values[comparison.worst_model] * 100).toFixed(1)}%)</p>
                            <p><strong>Difference:</strong> ${(comparison.range * 100).toFixed(1)}%</p>
                        </div>
                    `
    ).
        join('')
    }
    </div>

    <h3>Detailed Results</h3>
    <div class="model-results">
    ${Object.entries(data.models).map(([model, result]) => `
                        <div class="model-result">
                            <h4>${model}</h4>
            ${result.metrics ? `
            <p>Accuracy: ${(result.metrics.accuracy * 100).toFixed(1)}%
    </p>
    <p>Hallucination Rate: ${(result.metrics.hallucination_rate * 100).toFixed(1)}%</p>
    <p>Confidence: ${(result.metrics.confidence * 100).toFixed(1)}%</p>
            ` : ` < p

    class

    = "error-message" > Error
    : ${result.error}</p>
    `}
                        </div>
                    `
    ).join('')
    }
    </div>
    `;
        }
    }
</script>
</body>
</html>